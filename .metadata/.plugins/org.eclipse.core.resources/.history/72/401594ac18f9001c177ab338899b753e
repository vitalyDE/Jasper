<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.2.0.final using JasperReports Library version 6.2.0  -->
<!-- 2022-02-28T15:55:04 -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="specimen_services_undone" pageWidth="555" pageHeight="842" columnWidth="555" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0" uuid="1441f28b-7d07-4345-9ab0-29ec37bc3a8e">
	<property name="com.jaspersoft.studio.unit." value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageHeight" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.topMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.bottomMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.leftMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.rightMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnSpacing" value="pixel"/>
	<parameter name="RESEARCH_ID" class="java.lang.String"/>
	<parameter name="LANG" class="java.lang.String"/>
	<queryString language="plsql">
		<![CDATA[WITH
FLG AS ( -- ищем: есть ли результаты для промежуточной печати
  SELECT DISTINCT WP.PRINT_TYPE
    FROM SOLUTION_LAB.ORDERWORKFLOW OWF,
         SOLUTION_LAB.ORDER_INFO OI,
         SOLUTION_LAB.WORKFLOW WF,
         SOLUTION_LAB.WRKWORKPLACE WWP,
         SOLUTION_LAB.WORKPLACE WP,
         SOLUTION_LAB.RESULT R,
         SOLUTION_LAB.RESULT_VALUE RV
   WHERE OWF.Order_ID = OI.ID
     AND OI.RESEARCH_ID = $P{RESEARCH_ID}
     AND OWF.WORKFLOW_ID = WF.ID
     AND WWP.WORK_ID = WF.WORK_ID
     AND WP.ID = WWP.WORKPLACE_ID
     AND WP.PRINT_TYPE = 1 -- только если промежуточная печать
     AND R.ORDERWORKFLOW_ID = OWF.ID
     AND RV.RESULT_ID = R.ID
     AND RV.CHECK_STATUS = 1
         AND RV.DENY_PRINT_STATUS = 0 -- смотрим только проверенные и поступающие в печать
       ),
MAT AS ( -- статус материала
  SELECT STATUS
    FROM SOLUTION_LAB.RESEARCH
   WHERE ID = $P{RESEARCH_ID}
       ),
SRVC AS ( -- берем все не выполненные услуги
  SELECT DECODE(OI.CHECK_STATUS, 1, 1, 0) AS STATUS_ID,
         DECODE(OI.CHECK_STATUS, 1, 'отменена', 'в работе') AS STATUS,
         SD.CODE,
         SD.TEXT,
         SD.PRINT_CODE,
         SD.PRINT_TEXT,
         NVL(SD.LAB_SHORT_TEXT, SD.TEXT) AS LAB_TEXT
    FROM SOLUTION_LAB.ORDER_INFO OI,
         SOLUTION_MED.SRVDEP SD
   WHERE OI.RESEARCH_ID = $P{RESEARCH_ID}
     AND OI.SRVDEP_ID = SD.KEYID
     AND NVL(OI.OK_STATUS, 0) = 0
   ORDER BY STATUS, SD.CODE
        )
SELECT SRVC.* -- берем услуги в работе, только для промежуточной печати
  FROM SRVC,
       FLG,
       MAT
 WHERE FLG.PRINT_TYPE = 1
   AND MAT.STATUS IN ('A', 'N')
   AND SRVC.STATUS_ID = 0
/* UNION -- соединяем с отмененными услугами, только для промежуточной и полной печати
SELECT SRVC.*
  FROM SRVC
     , FLG
     , MAT
 WHERE SRVC.STATUS_ID = 1
   AND ((MAT.STATUS IN ('R', 'F')) OR (FLG.PRINT_TYPE = 1 AND MAT.STATUS IN ('A', 'N'))) */]]>
	</queryString>
	<field name="PRINT_CODE" class="java.lang.String"/>
	<field name="TEXT" class="java.lang.String"/>
	<field name="STATUS" class="java.lang.String"/>
	<pageHeader>
		<band height="15" splitType="Stretch">
			<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
			<textField>
				<reportElement x="0" y="0" width="555" height="15" uuid="f51e86e5-db1f-45e7-8544-21a1794547dc">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<box padding="0" topPadding="1" leftPadding="1" bottomPadding="1" rightPadding="1">
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Left" verticalAlignment="Bottom">
					<font fontName="Neuron" size="12" isBold="true" isUnderline="true" isStrikeThrough="false"/>
					<paragraph spacingBefore="0" spacingAfter="0"/>
				</textElement>
				<textFieldExpression><![CDATA["Заказанные, но не выполненные исследования"]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<detail>
		<band height="13">
			<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
			<textField isStretchWithOverflow="true">
				<reportElement stretchType="RelativeToTallestObject" x="0" y="0" width="555" height="13" uuid="7f5bf477-9516-4655-873d-6470aa7326f0"/>
				<box padding="1" topPadding="0" leftPadding="5" bottomPadding="0" rightPadding="0">
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.6" lineStyle="Dotted" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font fontName="Neuron" size="12"/>
					<paragraph leftIndent="0" rightIndent="5"/>
				</textElement>
				<textFieldExpression><![CDATA[EQUALS($F{PRINT_CODE},null) ? $F{TEXT}:
"(" + $F{PRINT_CODE} + ") " + $F{TEXT}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
</jasperReport>
